---
# Install Ruby

- name: Ensure APT is updated
  apt:
    update_cache: true
    cache_valid_time: 600

- name: Ensure APT dependencies are installed
  apt:
    name: "{{ item }}"
    state: present
    install_recommends: false
  with_items:
    - build-essential
    - curl
    - gcc
    - unzip

- name: Unarchive ruby source
  unarchive:
    src: "https://cache.ruby-lang.org/pub/ruby/{{ ruby_version[:-2]}}/ruby-{{ ruby_version }}.zip"
    dest: "{{ tmp_dir }}"
    remote_src: true

- name: Build ruby from source
  command: "{{ item }}"
  args:
    chdir: "{{ tmp_dir }}/ruby-{{ ruby_version }}"
  changed_when: false
  with_items:
    - ./configure
    - make
    - make install

- name: Ensure temp folder is absent
  file:
    path: "{{ tmp_dir }}/ruby-{{ ruby_version }}"
    state: absent
